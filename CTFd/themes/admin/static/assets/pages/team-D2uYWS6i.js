import{_ as x,C as d,y,u as w,c as g,a as f,h as J,l as F,m as C,F as j,r as D,b as N,o as b,j as R,t as U,q as $,$ as s,O as A,P as z,V as M,z as q}from"./main-C8Di_FaK.js";import{c as E,u as S}from"../graphs-D8rkwgB5.js";import{C as B}from"../CommentBox-Cq_mjxX0.js";import"../echarts.common-_7CMSJr3.js";const L={name:"UserAddForm",props:{team_id:Number},data:function(){return{searchedName:"",awaitingSearch:!1,emptyResults:!1,userResults:[],selectedResultIdx:0,selectedUsers:[]}},methods:{searchUsers:function(){if(this.selectedResultIdx=0,this.searchedName==""){this.userResults=[];return}d.fetch(`/api/v1/users?view=admin&field=name&q=${this.searchedName}`,{method:"GET",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success&&(this.userResults=e.data.slice(0,10))})},moveCursor:function(e){switch(e){case"up":this.selectedResultIdx&&(this.selectedResultIdx-=1);break;case"down":this.selectedResultIdx<this.userResults.length-1&&(this.selectedResultIdx+=1);break}},selectUser:function(e){e===void 0&&(e=this.selectedResultIdx);let t=this.userResults[e];this.selectedUsers.some(n=>n.id===t.id)===!1&&this.selectedUsers.push(t),this.userResults=[],this.searchedName=""},removeSelectedUser:function(e){this.selectedUsers=this.selectedUsers.filter(t=>t.id!==e)},handleAddUsersRequest:function(){let e=[];return this.selectedUsers.forEach(t=>{let i={user_id:t.id};e.push(d.fetch(`/api/v1/teams/${this.$props.team_id}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i)}))}),Promise.all(e)},handleRemoveUsersFromTeams:function(){let e=[];return this.selectedUsers.forEach(t=>{let i={user_id:t.id};e.push(d.fetch(`/api/v1/teams/${t.team_id}/members`,{method:"DELETE",body:JSON.stringify(i)}))}),Promise.all(e)},addUsers:function(){let e=[];if(this.selectedUsers.forEach(t=>{t.team_id&&e.push(t.name)}),e.length){let t=y(e.join(", "));w({title:"Confirm Team Removal",body:`The following users are currently in teams:<br><br> ${t} <br><br>Are you sure you want to remove them from their current teams and add them to this one? <br><br>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!`,success:()=>{this.handleRemoveUsersFromTeams().then(i=>{this.handleAddUsersRequest().then(n=>{window.location.reload()})})}})}else this.handleAddUsersRequest().then(t=>{window.location.reload()})}},watch:{searchedName:function(e){this.awaitingSearch===!1&&setTimeout(()=>{this.searchUsers(),this.awaitingSearch=!1},1e3),this.awaitingSearch=!0}}},V={class:"form-group"},G=f("label",null,"Search Users",-1),H={class:"form-group"},K=["onClick"],Q={class:"form-group"},W={key:0,class:"text-center"},Y=f("span",{class:"text-muted"}," No users found ",-1),X=[Y],Z={class:"list-group"},ee=["onClick"],te={class:"form-group"};function se(e,t,i,n,l,r){return b(),g("div",null,[f("div",V,[G,J(f("input",{type:"text",class:"form-control",placeholder:"Search for users","onUpdate:modelValue":t[0]||(t[0]=a=>e.searchedName=a),onKeyup:[t[1]||(t[1]=C(a=>r.moveCursor("down"),["down"])),t[2]||(t[2]=C(a=>r.moveCursor("up"),["up"])),t[3]||(t[3]=C(a=>r.selectUser(),["enter"]))]},null,544),[[F,e.searchedName]])]),f("div",H,[(b(!0),g(j,null,D(e.selectedUsers,a=>(b(),g("span",{class:"badge badge-primary mr-1",key:a.id},[R(U(a.name)+" ",1),f("a",{class:"btn-fa",onClick:c=>r.removeSelectedUser(a.id)}," Ã—",8,K)]))),128))]),f("div",Q,[e.userResults.length==0&&this.searchedName!=""&&e.awaitingSearch==!1?(b(),g("div",W,X)):N("",!0),f("ul",Z,[(b(!0),g(j,null,D(e.userResults,(a,c)=>(b(),g("li",{class:$({"list-group-item":!0,active:c===e.selectedResultIdx}),key:a.id,onClick:v=>r.selectUser(c)},[R(U(a.name)+" ",1),a.team_id?(b(),g("small",{key:0,class:$({"float-right":!0,"text-white":c===e.selectedResultIdx,"text-muted":c!==e.selectedResultIdx})}," already in a team ",2)):N("",!0)],10,ee))),128))])]),f("div",te,[f("button",{class:"btn btn-success d-inline-block float-right",onClick:t[4]||(t[4]=a=>r.addUsers())}," Add Users ")])])}const ie=x(L,[["render",se]]);function ne(e){console.log(e.childNodes);let t=e.childNodes[0];t.id.length<5e3?(e.removeChild(t),e.innerHTML=t.id):(t.src="data:text/plain;base64,"+atob(t.id),t.id="",t.onclick=re)}function ae(e){e.preventDefault();const t=s("#team-info-create-form").serializeJSON(!0);t.fields=[];for(const i in t)if(i.match(/fields\[\d+\]/)){let n={},l=parseInt(i.slice(7,-1));n.field_id=l,n.value=t[i],t.fields.push(n),delete t[i]}d.fetch("/api/v1/teams",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(i){return i.json()}).then(function(i){if(i.success){const n=i.data.id;window.location=d.config.urlRoot+"/admin/teams/"+n}else s("#team-info-create-form > #results").empty(),Object.keys(i.errors).forEach(function(n,l){s("#team-info-create-form > #results").append(A({type:"error",body:i.errors[n]}));const r=s("#team-info-create-form").find("input[name={0}]".format(n)),a=s(r);a.addClass("input-filled-invalid"),a.removeClass("input-filled-valid")})})}function oe(e){e.preventDefault();let t=s("#team-info-edit-form").serializeJSON(!0);t.fields=[];for(const i in t)if(i.match(/fields\[\d+\]/)){let n={},l=parseInt(i.slice(7,-1));n.field_id=l,n.value=t[i],t.fields.push(n),delete t[i]}d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(i){return i.json()}).then(function(i){i.success?window.location.reload():(s("#team-info-form > #results").empty(),Object.keys(i.errors).forEach(function(n,l){s("#team-info-form > #results").append(A({type:"error",body:i.errors[n]}));const r=s("#team-info-form").find("input[name={0}]".format(n)),a=s(r);a.addClass("input-filled-invalid"),a.removeClass("input-filled-valid")}))})}function re(e){console.log(e.srcElement),q({title:"Visioneurs",body:'<img src="'+e.srcElement.src+'" style="width: 100%;" height="auto">',button:"retour"})}function O(e){let i=s("input[data-submission-type=incorrect]:checked").map(function(){return s(this).data("submission-id")}),n=i.length===1?"submission":"submissions";w({title:"Correct Submissions",body:`Are you sure you want to mark ${i.length} ${n} correct?`,success:function(){const l=[];for(var r of i){let a=d.fetch(`/api/v1/submissions/${r}`,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({type:"correct"})});l.push(a)}Promise.all(l).then(a=>{window.location.reload()})}})}function I(e,t){let i,n,l;switch(t){case"solves":i=s("input[data-submission-type=correct]:checked"),n="solve",l="Solves";break;case"fails":i=s("input[data-submission-type=incorrect]:checked"),n="fail",l="Fails";break}let r=i.map(function(){return s(this).data("submission-id")}),a=r.length===1?n:n+"s";w({title:`Delete ${l}`,body:`Are you sure you want to delete ${r.length} ${a}?`,success:function(){const c=[];for(var v of r)c.push(d.api.delete_submission({submissionId:v}));Promise.all(c).then(k=>{window.location.reload()})}})}function le(e){let t=s("input[data-award-id]:checked").map(function(){return s(this).data("award-id")}),i=t.length===1?"award":"awards";w({title:"Delete Awards",body:`Are you sure you want to delete ${t.length} ${i}?`,success:function(){const n=[];for(var l of t){let r=d.fetch("/api/v1/awards/"+l,{method:"DELETE",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}});n.push(r)}Promise.all(n).then(r=>{window.location.reload()})}})}function de(e){e.preventDefault();let t=s("input[data-missing-challenge-id]:checked").map(function(){return s(this).data("missing-challenge-id")}),i=t.length===1?"challenge":"challenges";w({title:"Mark Correct",body:`Are you sure you want to mark ${t.length} ${i} correct for ${y(window.TEAM_NAME)}?`,success:function(){q({title:"User Attribution",body:`
        Which user on ${y(window.TEAM_NAME)} solved these challenges?
        <div class="pb-3" id="query-team-member-solve">
        ${s("#team-member-select").html()}
        </div>
        `,button:"Mark Correct",success:function(){const n=s("#query-team-member-solve > select").val(),l=[];for(var r of t){let a={provided:"MARKED AS SOLVED BY ADMIN",user_id:n,team_id:window.TEAM_ID,challenge_id:r,type:"correct"},c=d.fetch("/api/v1/submissions",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(a)});l.push(c)}Promise.all(l).then(a=>{window.location.reload()})}})}})}const P={team:[e=>d.api.get_team_solves({teamId:e}),e=>d.api.get_team_fails({teamId:e}),e=>d.api.get_team_awards({teamId:e})],user:[e=>d.api.get_user_solves({userId:e}),e=>d.api.get_user_fails({userId:e}),e=>d.api.get_user_awards({userId:e})]},ce=(e,t,i,n)=>{let[l,r,a]=P[e];Promise.all([l(n),r(n),a(n)]).then(c=>{E("score_graph","#score-graph",c,e,t,i,n),E("category_breakdown","#categories-pie-graph",c,e,t,i,n),E("solve_percentages","#keys-pie-graph",c,e,t,i,n)})},me=(e,t,i,n)=>{let[l,r,a]=P[e];Promise.all([l(n),r(n),a(n)]).then(c=>{S("score_graph","#score-graph",c,e,t,i,n),S("category_breakdown","#categories-pie-graph",c,e,t,i,n),S("solve_percentages","#keys-pie-graph",c,e,t,i,n)})};s(()=>{s("#team-captain-form").submit(function(o){o.preventDefault();const m=s("#team-captain-form").serializeJSON(!0);d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(m)}).then(function(u){return u.json()}).then(function(u){u.success?window.location.reload():(s("#team-captain-form > #results").empty(),Object.keys(u.errors).forEach(function(p,T){s("#team-captain-form > #results").append(A({type:"error",body:u.errors[p]}));const h=s("#team-captain-form").find("select[name={0}]".format(p)),_=s(h);_.addClass("input-filled-invalid"),_.removeClass("input-filled-valid")}))})}),s(".edit-team").click(function(o){s("#team-info-edit-modal").modal("toggle")}),s(".invite-team").click(function(o){d.fetch(`/api/v1/teams/${window.TEAM_ID}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(m){return m.json()}).then(function(m){if(m.success){let u=m.data.code,p=`${window.location.origin}${d.config.urlRoot}/teams/invite?code=${u}`;s("#team-invite-modal input[name=link]").val(p),s("#team-invite-modal").modal("toggle")}})}),s("#team-invite-link-copy").click(function(o){z(o,"#team-invite-link")});let e=document.getElementsByClassName("imageContainer");for(let o=0;o<e.length;o++)ne(e[o]);s(".members-team").click(function(o){s("#team-add-modal").modal("toggle")}),s(".edit-captain").click(function(o){s("#team-captain-modal").modal("toggle")}),s(".award-team").click(function(o){s("#team-award-modal").modal("toggle")}),s(".addresses-team").click(function(o){s("#team-addresses-modal").modal("toggle")}),s("#user-award-form").submit(function(o){o.preventDefault();const m=s("#user-award-form").serializeJSON(!0);if(m.user_id=s("#award-member-input").val(),m.team_id=window.TEAM_ID,s("#user-award-form > #results").empty(),!m.user_id){s("#user-award-form > #results").append(A({type:"error",body:"Please select a team member"}));return}m.user_id=parseInt(m.user_id),d.fetch("/api/v1/awards",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(m)}).then(function(u){return u.json()}).then(function(u){u.success?window.location.reload():(s("#user-award-form > #results").empty(),Object.keys(u.errors).forEach(function(p,T){s("#user-award-form > #results").append(A({type:"error",body:u.errors[p]}));const h=s("#user-award-form").find("input[name={0}]".format(p)),_=s(h);_.addClass("input-filled-invalid"),_.removeClass("input-filled-valid")}))})}),s(".delete-member").click(function(o){o.preventDefault();const m=s(this).attr("member-id"),u=s(this).attr("member-name"),p={user_id:m},T=s(this).parent().parent();w({title:"Remove Member",body:"Are you sure you want to remove {0} from {1}? <br><br><strong>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!</strong>".format("<strong>"+y(u)+"</strong>","<strong>"+y(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID+"/members",{method:"DELETE",body:JSON.stringify(p)}).then(function(h){return h.json()}).then(function(h){h.success&&T.remove()})}})}),s(".delete-team").click(function(o){w({title:"Delete Team",body:"Are you sure you want to delete {0}".format("<strong>"+y(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"DELETE"}).then(function(m){return m.json()}).then(function(m){m.success&&(window.location=d.config.urlRoot+"/admin/teams")})}})}),s("#solves-delete-button").click(function(o){I(o,"solves")}),s("#correct-fail-button").click(O),s("#fails-delete-button").click(function(o){I(o,"fails")}),s("#correct-submissions-button").click(O),s("#submissions-delete-button").click(function(o){I(o,"fails")}),s("#awards-delete-button").click(function(o){le()}),s("#missing-solve-button").click(function(o){de(o)}),s("#team-info-create-form").submit(ae),s("#team-info-edit-form").submit(oe);const t=M.extend(B);let i=document.createElement("div");document.querySelector("#comment-box").appendChild(i),new t({propsData:{type:"team",id:window.TEAM_ID}}).$mount(i);const n=M.extend(ie);let l=document.createElement("div");document.querySelector("#team-add-modal .modal-body").appendChild(l),new n({propsData:{team_id:window.TEAM_ID}}).$mount(l);let r,a,c,v;({type:r,id:a,name:c,account_id:v}=window.stats_data);let k;s("#team-statistics-modal").on("shown.bs.modal",function(o){ce(r,a,c,v),k=setInterval(()=>{me(r,a,c,v)},3e5)}),s("#team-statistics-modal").on("hidden.bs.modal",function(o){clearInterval(k)}),s(".statistics-team").click(function(o){s("#team-statistics-modal").modal("toggle")})});
